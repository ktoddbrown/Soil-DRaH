---
title: "CPEAT_2024April"
author: "Vaasuki Marupaka"
date: "April 2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# read in the CPEAT. datasets using the R script
CPEAT <- readCPEAT(dataDir, format = "byDataType") # reads in 876 datasets from PANGAEA into the dataDir
allCores.df <- CPEAT[['core']]
allStudy.df <- CPEAT[['study']]
allParameters.df  <- CPEAT[['parameters']]
allAnnotations <- CPEAT[['annotation']]
```

# Shoestring the data

Before merging the data with the annotations we first need to make all the data tables long tables with the following tuple: `table_id`, `row_number`, `column_id`, `with_entry`.
This echoes the format of the data annotations and will allow us to join the two tables together.

```{r}
#for each of the items (tibbles) in the original data list

#CPEAT$study <- CPEAT$study %>% 
#  dplyr::mutate(across(c('LATITUDE', 'LONGITUDE'), as.character))

CPEAT$longtable <- CPEAT$study %>%
  mutate(row_number = row_number()) %>% 
  pivot_longer(cols = -row_number, names_to = 'column_id', values_to = 'with_entry', values_drop_na = TRUE) 

```

Join the table with the annotations, matching the rows by `table id` and `column id`.
Replace the `--` values with those in the data table. The resulting table now has a combination of the annotated information and the observation values. Note that each row in the original dataset will now have multiple rows describing the observation.

```{r}
# now let us try appending the annotations for the same 
CPEAT.dataAnnotation <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", 
                                   sheet = "CPEAT_August2023", 
                                   range = "CPEAT_August2023!A:F",
                                   col_types = "c") %>% 
  filter(study_id == 'CPEAT', table_id == "study") 

CPEAT_longtable <- CPEAT$longtable %>% 
  full_join(CPEAT.dataAnnotation, 
              by = join_by(column_id),
              suffix = c('.data', ''),
              relationship = "many-to-many") %>% 
  mutate(
      with_entry = dplyr::if_else((with_entry == "--") | is.na(with_entry),
                                  with_entry.data, with_entry)) %>%
  select(-with_entry.data)

# now let us look at the core table
CPEAT.dataAnnotation_core <- read_sheet("https://docs.google.com/spreadsheets/d/1mllMhm2V2kMv6KvPSnuXDEBWAS-2okWK2F4mXbSjphU/edit?usp=sharing", 
                                   sheet = "CPEAT_August2023", 
                                   range = "CPEAT_August2023!A:F",
                                   col_types = "c") %>% 
  filter(study_id == 'CPEAT', table_id == "core") 

CPEAT_core <- CPEAT$core %>%
  mutate(row_number = row_number()) %>% 
  pivot_longer(cols = -row_number, names_to = 'column_id', values_to = 'with_entry', values_drop_na = TRUE)

CPEAT_core_long <- CPEAT_core %>% 
  full_join(CPEAT.dataAnnotation_core, 
              by = join_by(column_id),
              suffix = c('.data', ''),
              relationship = "many-to-many") %>% 
  mutate(
      with_entry = dplyr::if_else((with_entry == "--") | is.na(with_entry),
                                  with_entry.data, with_entry)) %>%
  select(-with_entry.data)
```

## Including Plots

```{r}


```

